#!/bin/bash
# Generator Script for Fail2Ban.WebExploits
# REPO: https://github.com/mitchellkrogza/Fail2Ban.WebExploits
# Copyright Mitchell Krog - mitchellkrog@gmail.com

tmplt=tmplt
input=${TRAVIS_BUILD_DIR}/input-source/exploits.list
output=${TRAVIS_BUILD_DIR}/webexploits.conf
version=V0.1.${TRAVIS_BUILD_NUMBER}

# ************************************
# Generate
# ************************************

sort -u ${input1} -o ${input1}

printf '%s\n' "# Fail2Ban Web Exploits Filter" >> ${tmplt}
printf '%s\n' "# Author & Copyright: Mitchell Krog - mitchellkrog@gmail.com" >> ${tmplt}
printf '%s\n' "# REPO: https://github.com/mitchellkrogza/Fail2Ban.WebExploits" >> ${tmplt}
printf '%s%s\n\n' "# " "${version}" >> ${tmplt}
printf '%s\n' "[Definition]" >> ${tmplt}
printf '\n\n' >> ${tmplt}
printf '%s\n' "failregex = ^<HOST> -.*GET.*(/.git/config)" >> ${tmplt}

# Now loop and write

while IFS= read -r LINE
do
printf '%s%s%s%s\n' "            " "^<HOST> -.*GET.*(" "${LINE}" ")" >> ${tmplt}
done < ${input}
printf '\n%s\n' "ignoreregex ="  >> ${tmplt}
mv ${tmplt} ${output}

# ************************************************
# Activate Dos2Unix 
# ************************************************

dos2unix ${output}

# Now commit the changes

cd ${TRAVIS_BUILD_DIR}

# *******************************
# Remove Remote Added by TravisCI
# *******************************

git remote rm origin

# **************************
# Add Remote with Secure Key
# **************************

git remote add origin https://${GH_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git

# *********************
# Set Our Git Variables
# *********************

git config --global user.email "${GIT_EMAIL}"
git config --global user.name "${GIT_NAME}"
git config --global push.default simple

# *******************************************
# Make sure we have checked out master branch
# *******************************************

git checkout master

# *************************************
# Add all the modified files and commit
# *************************************

git add -A
git commit -am "V0.1.${TRAVIS_BUILD_NUMBER} [ci skip]"
sudo git push origin master

# **********************
# Exit With Error Number
# **********************

exit ${?}


